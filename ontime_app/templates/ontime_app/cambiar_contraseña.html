{% extends 'ontime_app/base.html' %}
{% load static %}

{% block title %}Cambiar Contraseña - OnTime{% endblock %}

{% block content %}
<div class="bg-gray-100 shadow-xl rounded-3xl p-10 w-full max-w-lg mx-auto mt-18 animate__animated animate__fadeIn animate__faster">
  
  <h2 class="text-4xl font-extrabold text-gray-800 animate-pulse text-center mb-6">Cambiar Contraseña</h2>
  <p class="text-center text-gray-600 mb-8">Por favor ingresa tu nueva contraseña para continuar.</p>

  <form id="formCambiar" method="POST" onsubmit="return validarFormulario()">
    {% csrf_token %}

    <!-- Nueva contraseña -->
    <div class="mb-6 relative">
      <label for="nueva_contrasena" class="block text-sm font-medium text-gray-800 mb-1">Nueva contraseña</label>
      <div class="relative">
        <input 
          type="password" 
          id="nueva_contrasena" 
          name="nueva_contrasena" 
          required
          placeholder="Nueva contraseña"
          class="mt-1 block w-full px-4 py-3 border-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-green-500 pr-12 transition-all duration-300 text-gray-800" 
        >
        <div class="absolute inset-y-0 right-3 flex items-center cursor-pointer" onclick="togglePassword('nueva_contrasena', 'iconoOjo1')">
          <svg id="iconoOjo1" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M2.458 12C3.732 7.943 7.523 5 12 5c4.477 0 8.268 2.943 9.542 7-1.274 4.057-5.065 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
          </svg>
        </div>
      </div>
    </div>

    <!-- Repetir contraseña -->
    <div class="mb-6 relative">
      <label for="repetir_contrasena" class="block text-sm font-medium text-gray-800 mb-1">Repetir contraseña</label>
      <div class="relative">
        <input 
          type="password" 
          id="repetir_contrasena" 
          name="repetir_contrasena" 
          required
          placeholder="Repite la nueva contraseña"
          class="mt-1 block w-full px-4 py-3 border-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-green-500 pr-12 transition-all duration-300 text-gray-800" 
        >
        <div class="absolute inset-y-0 right-3 flex items-center cursor-pointer" onclick="togglePassword('repetir_contrasena', 'iconoOjo2')">
          <svg id="iconoOjo2" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M2.458 12C3.732 7.943 7.523 5 12 5c4.477 0 8.268 2.943 9.542 7-1.274 4.057-5.065 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
          </svg>
        </div>
        <!-- Contenedor para errores -->
        <div class="absolute w-full mt-1 h-10">
          <p id="errorCoincidencia" class="text-red-600 text-sm hidden">Las contraseñas no coinciden.</p>
          <p id="errorLongitud" class="text-red-600 text-sm hidden">La contraseña debe tener al menos 8 caracteres.</p>
        </div>
      </div>
    </div>

    <!-- Espacio entre los errores y el botón -->
    <div class="mb-6"></div>

    <!-- Botón -->
    <button 
      type="submit" 
      id="btnCambiar"
      class="w-full bg-green-600 text-white py-3 rounded-lg hover:bg-green-700 transition duration-300 shadow-md focus:ring-4 focus:ring-green-500 focus:outline-none mt-6">
      Cambiar contraseña
    </button>

    <!-- Loading -->
    <div id="loadingSpinner" class="hidden mt-6 flex justify-center items-center">
      <svg class="animate-spin h-8 w-8 text-green-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v8z"></path>
      </svg>
    </div>
  </form>
</div>

<script>
  function togglePassword(inputId, iconId) {
    const input = document.getElementById(inputId);
    const icon = document.getElementById(iconId);

    if (input.type === "password") {
      input.type = "text";
    } else {
      input.type = "password";
    }
  }

  function validarFormulario() {
    const pass1 = document.getElementById("nueva_contrasena").value;
    const pass2 = document.getElementById("repetir_contrasena").value;
    const errorCoincidencia = document.getElementById("errorCoincidencia");
    const errorLongitud = document.getElementById("errorLongitud");
    const spinner = document.getElementById("loadingSpinner");
    const form = document.getElementById("formCambiar");

    let valido = true;

    // Verifica longitud
    if (pass1.length < 8) {
      errorLongitud.classList.remove("hidden");
      valido = false;
    } else {
      errorLongitud.classList.add("hidden");
    }

    // Verifica coincidencia
    if (pass1 !== pass2) {
      errorCoincidencia.classList.remove("hidden");
      valido = false;
    } else {
      errorCoincidencia.classList.add("hidden");
    }

    // Si todo está bien, muestra el spinner y redirige
    if (valido) {
      spinner.classList.remove("hidden");

      // Espera 2 segundos y redirige
      setTimeout(() => {
        window.location.href = "{% url 'contraseña_actualizada' %}";
      }, 2000);
    }

    return false;
  }
</script>
{% endblock %}
