{% extends 'ontime_app/base.html' %}
{% load static %}

{% block title %}Historial de Asistencia - OnTime{% endblock %}

{% block content %}
<div class="mt-6 text-center">
  <a href="javascript:history.back()" class="flex items-center text-gray-600 hover:text-green-800 transition-all duration-300">
    <i class="fas fa-arrow-left mr-2"></i>
    Regresar
  </a>
</div>

<div class="bg-gray-100 shadow-xl rounded-3xl p-6 md:p-10 w-full max-w-4xl mx-auto mt-18 animate__animated animate__fadeIn animate__faster">
  <h2 class="text-4xl font-extrabold text-gray-800 text-center mb-6 animate-pulse">Consulta tu Historial de Asistencia</h2>
  <p class="text-center text-gray-600 mb-8">Aquí podrás ver el registro completo de tus asistencias.</p>

  <!-- Filtros de búsqueda -->
  <div class="flex mb-6 gap-6">
    <div class="w-full md:w-1/3 text-gray-600">
      <label for="fecha_inicio" class="block text-sm font-medium text-gray-700">Fecha de inicio</label>
      <input type="date" id="fecha_inicio" class="w-full p-2 mt-1 rounded-md border border-gray-300 focus:outline-none focus:ring-2 focus:ring-green-500" />
    </div>

    <div class="w-full md:w-1/3 text-gray-600">
      <label for="fecha_fin" class="block text-sm font-medium text-gray-700">Fecha de fin</label>
      <input type="date" id="fecha_fin" class="w-full p-2 mt-1 rounded-md border border-gray-300 focus:outline-none focus:ring-2 focus:ring-green-500" />
    </div>

    <div class="w-full md:w-1/3 mt-5">
      <button class="bg-green-600 text-white py-4 px-6 w-full rounded-lg hover:bg-green-700 transition duration-300 shadow-md focus:ring-4 focus:ring-green-500 focus:outline-none" id="btn-filtrar">
        Filtrar
      </button>
    </div>
  </div>

  <!-- Tabla -->
  <div class="overflow-x-auto bg-white shadow-md rounded-lg p-6 max-h-96 overflow-y-auto">
    <table class="min-w-full table-auto">
      <thead class="bg-gray-200">
        <tr>
          <th class="px-6 py-3 text-left text-sm font-medium text-gray-800">Fecha</th>
          <th class="px-6 py-3 text-left text-sm font-medium text-gray-800">Curso/Competencia</th>
          <th class="px-6 py-3 text-left text-sm font-medium text-gray-800">Estado</th>
          <th class="px-6 py-3 text-left text-sm font-medium text-gray-800">Acción</th>
        </tr>
      </thead>
      <tbody class="text-sm font-normal text-gray-600" id="tabla-historial">
        <!-- Aquí se insertan las filas dinámicamente -->
      </tbody>
    </table>
  </div>

  <!-- Botón Ver más -->
  <div class="flex justify-center mt-8">
    <button class="bg-green-600 text-white py-2 px-4 rounded-lg hover:bg-green-700 transition duration-300 shadow-md focus:ring-4 focus:ring-green-500 focus:outline-none" id="btn-ver-mas">
      Ver más
    </button>
  </div>
</div>

<!-- Inyección de datos del backend -->
<script type="application/json" id="datos-asistencia">
  {{ datos_asistencia|safe }}
</script>

<!-- Script -->
<script>
  document.addEventListener('DOMContentLoaded', function () {
    let datosAsistencia = JSON.parse(document.getElementById('datos-asistencia').textContent);
    const filasPorPagina = 3;
    let paginaActual = 0;

    function mostrarHistorial() {
  const tabla = document.getElementById('tabla-historial');
  
  if (paginaActual === 0) {
    tabla.innerHTML = '';  // Limpiar solo si es la página 0 (inicia)
  }

  const inicio = paginaActual * filasPorPagina;
  const fin = inicio + filasPorPagina;
  const historialVisible = datosAsistencia.slice(inicio, fin);


      historialVisible.forEach(item => {
        const row = document.createElement('tr');
        row.classList.add('hover:bg-gray-50');
        const idDetalle = 'detalle-' + item.id;

        row.innerHTML = `
          <td class="px-6 py-4">${item.fecha}</td>
          <td class="px-6 py-4">${item.curso}</td>
          <td class="px-6 py-4 text-${item.estado === 'Asistido' ? 'green' : 'red'}-600">${item.estado}</td>
          <td class="px-6 py-4">
            <button id="btn-${idDetalle}" class="text-green-600 hover:text-green-700 underline" onclick="toggleDetalle('${idDetalle}')">
              Ver detalles ⯆
            </button>
          </td>
        `;
        tabla.appendChild(row);

        const filaDetalles = document.createElement('tr');
        filaDetalles.id = idDetalle;
        filaDetalles.classList.add('hidden');
        filaDetalles.innerHTML = `
          <td colspan="4" class="px-6 py-4 text-gray-500">
            <p>${item.detalles}</p>
          </td>
        `;
        tabla.appendChild(filaDetalles);
      });
    }

    document.getElementById('btn-ver-mas').addEventListener('click', function () {
      paginaActual++;
      mostrarHistorial();
    });

    // Filtro con AJAX sin recargar la página
    document.getElementById('btn-filtrar').addEventListener('click', function () {
      const fechaInicio = document.getElementById('fecha_inicio').value;
      const fechaFin = document.getElementById('fecha_fin').value;

      fetch(`/filtrar-asistencia/?fecha_inicio=${fechaInicio}&fecha_fin=${fechaFin}`)
        .then(response => response.json())
        .then(data => {
          datosAsistencia = data.datos;  // Actualizo el array con los datos filtrados
          paginaActual = 0;              // Reinicio la página para mostrar desde el inicio

          const tabla = document.getElementById('tabla-historial');
          tabla.innerHTML = '';          // Limpio la tabla antes de mostrar resultados

          if (datosAsistencia.length === 0) {
            tabla.innerHTML = `<tr><td colspan="4" class="text-center py-4 text-gray-500">No hay registros para esas fechas.</td></tr>`;
            return;
          }

          mostrarHistorial();
        })
        .catch(err => {
          console.error('Error al filtrar:', err);
          alert('Algo falló al filtrar, intenta de nuevo.');
        });
    });

    window.toggleDetalle = function(id) {
      const fila = document.getElementById(id);
      const boton = document.getElementById('btn-' + id);

      if (fila.classList.contains('hidden')) {
        fila.classList.remove('hidden');
        boton.innerHTML = 'Ocultar detalles ⯅';
      } else {
        fila.classList.add('hidden');
        boton.innerHTML = 'Ver detalles ⯆';
      }
    };

    mostrarHistorial();
  });
</script>
{% endblock %}
